<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Brian Scaturro - TDD With Mock Objects And PHPUnit</title>
	
	<meta name="description" content="The code writing expeditions and explorations of Brian Anthony Scaturro">
	
	<meta name="author" content="Brian Scaturro">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link href='http://fonts.googleapis.com/css?family=Anton' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/css/base.css">
	<link rel="stylesheet" href="/css/skeleton.css">
	<link rel="stylesheet" href="/css/layout.css">
	<link rel="stylesheet" href="/css/pygments.css">
	<link rel="shortcut icon" href="/images/favicon.ico">
        <link rel="alternate" type="application/atom+xml" title="brianscaturro.com feed" href="http://brianscaturro.com/atom.xml" />
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-10808090-11']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>
<body>
	<div class="container">

<div class="eleven columns alpha">
	<header id="branding">
		<a href="/">
			<div class="site-heading">Brian Scaturro</div>
			<div class="site-subheading">Fancy a dance?</div>
		</a>
	</header>
	<div id="main" role="main">
		<article>
			<h1>TDD With Mock Objects And PHPUnit<span class="post-date">27 Mar 2012</span></h1>
			<h2>The problem</h2>
<p>
Test driven development ,or TDD, should be no stranger to many folks out in the code wilds. Writing tests first aids in design as well as quality control. I am always amazed at how my own testing practices evolve. 
</p>
<p>
It wasn't until recently that I discovered the beauty (and common sense) of separating integration tests from unit tests. Yes yes, integration tests often test units too, but the main focus of these tests is to test how your units (you guessed it) integrate with other components (the server, database, services, etc...).
</p>
<p>
It can be tricky to isolate unit tests away from integration tests when your units are composed of something that is fundamentally useless without one of those components. Imagine a DB object, or a REST client, or a socket. Your unit tests need to test the units at their core, and not how they integrate with other resources. How do you test a unit that has a dependency on a socket object, without having to worry about opening and closing a socket connection every test?
</p>

<h2>Mock objects as the solution</h2>
<p>
These bad boys need to be part of every testers toolkit. We are going to use the socket scenario (and yes this is because it has been my most recent use case) to demonstrate how mock objects can be used to make more pure unit tests. Remember the goal is to separate your tests into unit tests and integration tests.
</p>

<h3>The unit to test</h3>
<p>
The unit in question is an object that encapsulates executing a socket command. Think command pattern. The language in question today is PHP, but the principle is the same in other environments. In fact it is a principle I use in the .NET realm with C# and <a href="http://code.google.com/p/moq/" title="Moq" target="_blank">Moq</a>.
</p>

Liquid error: No such file or directory - posix_spawnp

<p>
Take note that our <code>SocketCommand</code> object forms a dependency with the <code>BinarySocket</code> object. Let's take a look at the <code>BinarySocket</code> class.
</p>

Liquid error: No such file or directory - posix_spawnp

<p>
As you can see, when a <code>BinarySocket</code> is instantiated, a connection is opened on the given ip and port. This could really slow down our tests if these connections are being opened all over the place.
</p>

<h3>Using mock objects to test behavior</h3>
<p>
Rather than creating these socket objects and having connections opened, we will mock the <code>BinarySocket</code> object in order to test its role in the <code>SocketCommand</code> object. As you can see from the <code>SocketCommand</code> code above, the <code>BinarySocket</code> is used within the <code>execute</code> method of the <code>SocketCommand</code>. We need to test this behavior without being concerned with whether the <code>BinarySocket</code> is making a connection or not.
</p>

<p>
Here is how we are going to set up the <code>SocketCommand</code> test case using PHPUnit:
</p>

Liquid error: No such file or directory - posix_spawnp

<p>
Using PHPUnit's mock library, it is easy to setup an object that will meet the requirements of the <code>SocketCommand</code> constructor. In a library like <a href="http://code.google.com/p/moq/" title="Moq" target="_blank">Moq</a> in .NET town, you would be more likely to test an interface instead of a concrete implementation, but PHP offers a little more "flexibility" here.
</p>

<p>
The mock object has already allowed us to meet the requirements of the <code>SocketCommand</code> constructor. Our mock object is effectively the required <code>BinarySocket</code>; It meets the required <code>BinarySocket</code> interface, and it does not have the added baggage of actually opening a socket connection.</p>

<p>
<p>
Remember the <code>SocketCommand</code> makes use of the <code>BinarySocket</code> in it's <code>execute</code> method. We want to make sure this is happening, and this is what we are going to test.</p>

<h3>Setting expectations</h3>

<p>
We need to tell our testing framework, that we <em>expect</em> the <code>execute</code> method of our tested unit to call our mock object's <code>write</code> method. Done!</p>

Liquid error: No such file or directory - posix_spawnp

<p>
Lets break this down.
</p>
<p>
<strong><code>expects($this->once())</code></strong>: This line tells the test runner to expect that the method we are testing will be called at least once. If it isn't, then an exception is thrown and the test fails.
</p>
<p>
<strong><code>method('write')</code></strong>: This is the method of the interface our object is mocking that will be called. In this case we are saying the <code>write</code> method of <code>BinarySocket</code> will be called.
</p>
<p>
<strong><code>with(...)</code></strong>: The <code>with</code> method of our mock object allows us to specify what arguments the chosen method will be called with.
</p>
<p>
Finally, after we set our expectations, we run the method on our unit to test. If that method does not call the mock object's <code>write</code> method in exactly the way we described it, then an exception will be thrown and the test will fail. Here is the complete test case.
</p>

Liquid error: No such file or directory - posix_spawnp

<p>
Remember the beauty of this is being able to separate unit tests from integration tests. We have made our <code>SocketCommand</code> testable without worrying about socket connections opening. This has the benefit of making our unit tests faster, but also more concerned with the actual business at hand.
</p>
<p>
Whatever the language, whatever the environment, mock objects are an indispensable tool, if you want to do effective test driven development that won't slow you or your tests down.
</p>
		</article>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
		    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		    var disqus_shortname = 'brianscaturro'; // required: replace example with your forum shortname

		    /* * * DON'T EDIT BELOW THIS LINE * * */
		    (function() {
		        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		    })();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	</div>
</div>
<aside class="four columns omega offset-by-one" id="sidebar">
	<img class="add-bottom photo" src="/images/steed.jpg" alt="some of my best thinking occurs on unicorns">
	<h2>Recent Posts</h2>
	<ul class='posts'>
		
		<li><h3><a href="/2012/09/17/monomials-polynomials-with-scala.html">Monomials and Polynomials With Scala and ScalaTest</a></h3></li>
		
		<li><h3><a href="/2012/09/06/number-system-with-scala.html">Dipping Into The Number System With Scala and ScalaTest</a></h3></li>
		
		<li><h3><a href="/2012/09/03/algebra-basics-with-scala.html">Algebra Basics With Scala and ScalaTest</a></h3></li>
		
		<li><h3><a href="/2012/06/12/blog-with-jekyll-and-github.html">Blogging With Jekyll And Github Pages</a></h3></li>
		
		<li><h3><a href="/">The rest....</a></h3></li>
	</ul>
</aside>
		<div class="sixteen columns alpha omega">
			<footer>
				&copy; 2012 Brian Scaturro - <a href="http://feeds.feedburner.com/brianscaturro" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/></a>&nbsp;<a id="subscribe-link" href="http://feeds.feedburner.com/brianscaturro" rel="alternate" type="application/rss+xml">subscribe</a>
			</footer>
		</div>
	</div>
	<script type="text/javascript" src="/js/site.js"></script>
</body>
</html>
